<%# 課程卡片元件 (Airbnb 風格) %>
<%# 使用方式: %>
<%#   render 'shared/product_card', product: @product %>
<%#   render 'shared/product_card', product: @product, show_badges: true %>
<%#   render 'shared/product_card', product: @product, compact: true %>
<%# 參數: %>
<%#   - product: Product 物件 (必填) %>
<%#   - show_badges: 是否顯示標籤 (預設 true) %>
<%#   - compact: 是否緊湊模式 (預設 false) %>
<%#   - lazy_image: 是否延遲載入圖片 (預設 true) %>

<% show_badges = local_assigns.fetch(:show_badges, true) %>
<% compact = local_assigns.fetch(:compact, false) %>
<% lazy_image = local_assigns.fetch(:lazy_image, true) %>

<%= link_to product_path(product),
    class: "group block bg-white rounded-2xl overflow-hidden border border-neutral-200 hover:shadow-xl hover:border-purple-200 transition-all duration-300" do %>

  <!-- 圖片區域 -->
  <div class="relative <%= compact ? 'aspect-[16/9]' : 'aspect-video' %> bg-gradient-to-br from-purple-50 to-pink-50 overflow-hidden">
    <% if product.respond_to?(:cover_image) && product.cover_image.attached? %>
      <%= image_tag product.cover_image,
          class: "w-full h-full object-cover group-hover:scale-105 transition-transform duration-500",
          loading: lazy_image ? "lazy" : "eager",
          alt: product.title %>
    <% else %>
      <!-- 預設漸層背景 + 圖示 -->
      <div class="absolute inset-0 flex items-center justify-center">
        <svg class="w-12 h-12 text-purple-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
        </svg>
      </div>
    <% end %>

    <% if show_badges %>
      <!-- 左上角標籤 -->
      <div class="absolute top-3 left-3 flex flex-wrap gap-2">
        <% if product.ai_enhanced? %>
          <span class="px-2 py-1 text-xs font-medium bg-white/90 text-purple-700 rounded-full backdrop-blur-sm shadow-sm">
            AI 精選
          </span>
        <% end %>
        <% if product.respond_to?(:featured?) && product.featured? %>
          <span class="px-2 py-1 text-xs font-medium bg-amber-100/90 text-amber-700 rounded-full backdrop-blur-sm shadow-sm">
            熱門
          </span>
        <% end %>
      </div>

      <!-- 右上角收藏按鈕 (預留) -->
      <button type="button"
              class="absolute top-3 right-3 w-8 h-8 flex items-center justify-center bg-white/80 rounded-full backdrop-blur-sm shadow-sm opacity-0 group-hover:opacity-100 transition-opacity hover:bg-white"
              onclick="event.preventDefault(); event.stopPropagation();">
        <svg class="w-4 h-4 text-neutral-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
        </svg>
      </button>
    <% end %>
  </div>

  <!-- 內容區域 -->
  <div class="<%= compact ? 'p-3' : 'p-4' %>">
    <!-- 類型 & 評分 -->
    <div class="flex items-center justify-between mb-2">
      <div class="flex items-center gap-2">
        <span class="text-xs text-neutral-400 uppercase tracking-wide">
          <%= product.content_type || 'Course' %>
        </span>
        <% if product.ai_metadata&.dig("difficulty") %>
          <span class="text-xs text-purple-600">
            <%= product.ai_metadata["difficulty"] %>
          </span>
        <% end %>
      </div>

      <% if product.product_score %>
        <div class="flex items-center gap-1">
          <svg class="w-3.5 h-3.5 text-amber-400" fill="currentColor" viewBox="0 0 20 20">
            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
          </svg>
          <span class="text-xs font-medium text-neutral-700">
            <%= product.product_score.quality_score %>
          </span>
        </div>
      <% end %>
    </div>

    <!-- 標題 -->
    <h3 class="<%= compact ? 'text-sm' : 'text-base' %> font-medium text-neutral-900 group-hover:text-purple-600 transition-colors line-clamp-2 mb-1">
      <%= product.title %>
    </h3>

    <!-- 描述 (非緊湊模式) -->
    <% unless compact %>
      <p class="text-sm text-neutral-500 line-clamp-2 mb-3">
        <%= product.ai_summary || truncate(product.description, length: 80) %>
      </p>
    <% end %>

    <!-- 賣家 & 價格 -->
    <div class="flex items-center justify-between <%= compact ? 'mt-2' : 'mt-3 pt-3 border-t border-neutral-100' %>">
      <span class="text-sm text-neutral-400 truncate max-w-[120px]">
        <%= product.seller_profile&.store_name || "Creator" %>
      </span>
      <span class="<%= compact ? 'text-base' : 'text-lg' %> font-semibold text-neutral-900">
        NT$ <%= number_with_delimiter(product.price.to_i) %>
      </span>
    </div>
  </div>
<% end %>
